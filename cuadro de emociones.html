<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cuadro de Emociones</title>
<link rel="stylesheet" href="styles.css">
<style>
/* Estilos para las notas */
.note {
background-color: #fff;
padding: 1rem;
border-radius: 10px;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
margin-bottom: 1rem;
position: relative;
}

.note textarea {
width: 100%;
padding: 10px;
margin-bottom: 10px;
border-radius: 5px;
border: 1px solid #ccc;
resize: vertical;
box-sizing: border-box;
}

.note button {
background-color: #ff6666;
color: #fff;
border: none;
padding: 10px 20px;
border-radius: 5px;
cursor: pointer;
transition: background-color 0.3s, transform 0.3s;
margin-bottom: 10px;
}

.note button:hover {
background-color: #ff3333;
transform: scale(1.05);
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.note .delete-button {
position: absolute;
top: 0.5rem;
right: 0.5rem;
background: none;
border: none;
cursor: pointer;
color: #ff6666;
font-size: 0.8rem;
transition: color 0.3s, transform 0.3s;
}

.note .delete-button:hover {
color: #ff3333;
transform: scale(1.1);
}

/* Estilos para el gráfico de emociones */
#emotion-chart {
margin-top: 2rem;
}

#emotion-chart canvas {
width: 100%;
max-width: 600px;
margin: 0 auto;
display: block;
}

/* Estilos para el perfil de usuario */
#user-profile {
margin: 20px 0;
padding: 20px;
background-color: #fff;
border-radius: 10px;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
display: flex;
flex-direction: column;
align-items: center;
}

#user-profile h2 {
margin-bottom: 10px;
}

#user-profile p {
margin-bottom: 10px;
}

#user-profile img {
width: 100px;
height: 100px;
border-radius: 50%;
object-fit: cover;
margin-bottom: 10px;
}

#profile-pic-form {
display: flex;
flex-direction: column;
align-items: center;
}

#profile-pic-form input {
margin-bottom: 10px;
}

#logout-button {
padding: 10px 20px;
background-color: #ff6666;
color: #fff;
border: none;
border-radius: 5px;
cursor: pointer;
}

#logout-button:hover {
background-color: #ff3333;
}
</style>
</head>
<body>
<header>
<h2>Cuadro de Emociones</h2>
<button id="menuButton">☰</button>
</header>
<nav id="menu">
<ul>
<li><a href="index.html">Inicio</a></li>
<li><a href="frases.html">Frases</a></li>
<li><a href="videos.html">Videos</a></li>
<li><a href="viajes.html">Viajes</a></li>
<li><a href="preguntas y respuestas.html">Preguntas y Respuestas</a></li>
<li><a href="reencuentro.html">Reencuentro</a></li>
</ul>
</nav>
<main>
<div id="user-profile" style="display: none;">
<h2>Perfil de Usuario</h2>
<img id="profile-pic" src="" alt="Imagen de Perfil">
<p id="user-email"></p>
<form id="profile-pic-form">
<input type="file" id="profile-pic-input" accept="image/*">
<button type="submit">Subir Imagen</button>
</form>
<button id="logout-button">Cerrar Sesión</button>
</div>

<form id="emotion-form">
<label for="emotion">Selecciona tu emoción:</label>
<select id="emotion" name="emotion">
<option value="Estoy feliz">Estoy feliz party</option>
<option value="Estoy triste">Estoy triste loudlycrying</option>
<option value="Estoy estresado">Estoy estresado wasntme</option>
<option value="Estoy enamorado">Estoy enamorado hearteyes</option>
<option value="Estoy cansado">Estoy cansado sweat</option>
<option value="Estoy emocionado">Estoy emocionado stareyes</option>
</select>
<label for="note">Nota:</label>
<input type="text" id="note" name="note">
<button type="submit">Guardar</button>
</form>
<div id="emotion-chart">
<h2>Gráfico de Emociones</h2>
<canvas id="emotionChart"></canvas>
</div>
<div id="notes-container">
<h2>Notas</h2>
</div>
</main>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js';
import { getFirestore, collection, addDoc, serverTimestamp, getDocs, deleteDoc, doc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js';
import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-storage.js';

const firebaseConfig = {
apiKey: "AIzaSyBfGBf5Zmp1hEZHT9aKIhTRcXjULD-jbGw",
authDomain: "mi-web-5402c.firebaseapp.com",
databaseURL: "https://mi-web-5402c-default-rtdb.europe-west1.firebasedatabase.app",
projectId: "mi-web-5402c",
storageBucket: "mi-web-5402c.appspot.com",
messagingSenderId: "31272724190",
appId: "1:31272724190:web:51fcc8750c51abf783844f"
};
  
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

// Verificar el estado de autenticación
// Verificar el estado de autenticación
onAuthStateChanged(auth, (user) => {
if (user) {
document.getElementById('user-profile').style.display = 'block';
document.getElementById('user-email').textContent = `Correo: ${user.email}`;
loadProfilePic(user.uid); // Cargar imagen de perfil
loadEmotions(); // Cargar emociones al autenticarse
} else {
window.location.href = 'login.html'; // Redirigir a la página de login si no está autenticado
}
});

// Cerrar Sesión
document.getElementById('logout-button').addEventListener('click', () => {
auth.signOut().then(() => {
console.log('Usuario desconectado');
window.location.href = 'login.html'; // Redirigir a la página de login
}).catch((error) => {
console.error('Error al cerrar sesión:', error);
});
});

// Subir imagen de perfil
document.getElementById('profile-pic-form').addEventListener('submit', async (e) => {
e.preventDefault();
const file = document.getElementById('profile-pic-input').files[0];
if (file) {
const user = auth.currentUser;
const storageRef = ref(storage, `profile_pics/${user.uid}`);
try {
await uploadBytes(storageRef, file);
const url = await getDownloadURL(storageRef);

const userDocRef = doc(db, 'users', user.uid);
const userDoc = await getDoc(userDocRef);

if (userDoc.exists()) {
await updateDoc(userDocRef, { profilePic: url });
} else {
await setDoc(userDocRef, { profilePic: url });
}

document.getElementById('profile-pic').src = url;
alert('Imagen de perfil subida con éxito');
} catch (error) {
console.error('Error al subir la imagen de perfil:', error);
}
}
});

// Cargar imagen de perfil
async function loadProfilePic(uid) {
try {
const userDoc = await getDoc(doc(db, 'users', uid));
if (userDoc.exists() && userDoc.data().profilePic) {
document.getElementById('profile-pic').src = userDoc.data().profilePic;
}
} catch (error) {
console.error('Error al cargar la imagen de perfil:', error);
}
}

// Guardar datos en Firebase
document.getElementById('emotion-form').addEventListener('submit', async (e) => {
e.preventDefault();

const emotion = document.getElementById('emotion').value;
const note = document.getElementById('note').value;

try {
await addDoc(collection(db, 'emotions'), {
emotion,
note,
timestamp: serverTimestamp()
});
alert('Emoción guardada con éxito');
loadEmotions(); // Recargar emociones después de guardar
} catch (e) {
console.error('Error al guardar la emoción:', e);
}
});

// Función para cargar emociones desde Firestore
async function loadEmotions() {
const emotionsContainer = document.getElementById('emotion-chart');
const notesContainer = document.getElementById('notes-container');
emotionsContainer.innerHTML = '<h2>Gráfico de Emociones</h2><canvas id="emotionChart"></canvas>';
notesContainer.innerHTML = '<h2>Notas</h2>';

try {
const querySnapshot = await getDocs(collection(db, 'emotions'));
const emotionsData = [];
querySnapshot.forEach((doc) => {
const emotionData = doc.data();
emotionData.id = doc.id; // Agregar el ID del documento
emotionsData.push(emotionData);
});
renderChart(emotionsData);
renderNotes(emotionsData);
} catch (e) {
console.error('Error al cargar las emociones: ', e);
}
}

let myChart; // Variable global para almacenar la instancia del gráfico
// Función para renderizar el gráfico
function renderChart(data) {
const canvas = document.getElementById('emotionChart');
if (!canvas) {
console.error("El elemento canvas no está disponible en el DOM.");
return;
}

const ctx = canvas.getContext('2d');
const emotions = data.map(item => item.emotion);
const counts = emotions.reduce((acc, emotion) => {
acc[emotion] = (acc[emotion] || 0) + 1;
return acc;
}, {});

// Si ya existe un gráfico, destruirlo antes de crear uno nuevo
if (myChart) {
myChart.destroy();
}

// Crear un nuevo gráfico y guardarlo en la variable global
myChart = new Chart(ctx, {
type: 'bar',
data: {
labels: Object.keys(counts),
datasets: [{
label: 'Frecuencia de Emociones',
data: Object.values(counts),
backgroundColor: 'rgba(255, 99, 132, 0.2)',
borderColor: 'rgba(255, 99, 132, 1)',
borderWidth: 1
}]
},
options: {
scales: {
y: {
beginAtZero: true
}
}
}
});
}

// Función para renderizar las notas
function renderNotes(data) {
const notesContainer = document.getElementById('notes-container');
data.forEach(item => {
const noteDiv = document.createElement('div');
noteDiv.classList.add('note');
noteDiv.innerHTML = `
<p><strong>Emoción:</strong> ${item.emotion}</p>
<p><strong>Nota:</strong> ${item.note}</p>
<textarea placeholder="Responder..."></textarea>
<button onclick="addResponse('${item.id}', this.previousElementSibling.value)">Responder</button>
<button class="delete-button" onclick="deleteEmotion('${item.id}')">Eliminar</button>
`;
notesContainer.appendChild(noteDiv);
});
}

// Función para agregar una respuesta a una nota
window.addResponse = async function(id, response) {
try {
const noteRef = doc(db, 'emotions', id);
await updateDoc(noteRef, {
response: response
});
alert('Respuesta guardada con éxito');
loadEmotions(); // Recargar emociones después de responder
} catch (e) {
console.error('Error al guardar la respuesta: ', e);
}
}

// Función para eliminar emociones de Firestore
window.deleteEmotion = async function(id) {
try {
await deleteDoc(doc(db, 'emotions', id));
alert('Emoción eliminada con éxito');
loadEmotions(); // Recargar emociones después de eliminar
} catch (e) {
console.error('Error al eliminar la emoción: ', e);
}
}
</script>
</body>
</html>
